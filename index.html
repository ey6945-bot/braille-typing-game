<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>점자 타자 게임</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
    body { margin:0; background:#0b0f17; color:#eaf0ff; }
    header{ padding:14px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; gap:10px; flex-wrap:wrap; }
    .pill{ background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; font-size:12px; }
    main{ display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; padding:14px; }
    @media (max-width: 900px){ main{ grid-template-columns:1fr; } }
    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; overflow:hidden; }
    .card h2{ margin:0; padding:12px 14px; font-size:14px; border-bottom:1px solid rgba(255,255,255,.10); }
    .content{ padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      cursor:pointer; border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10); color:#eaf0ff;
      padding:10px 12px; border-radius:12px; font-weight:800;
    }
    .btn.primary{ background: rgba(110,231,183,.18); border-color: rgba(110,231,183,.35); }
    select, input[type="range"]{
      background: rgba(0,0,0,.25);
      color:#eaf0ff;
      border:1px solid rgba(255,255,255,.16);
      border-radius: 10px;
      padding:6px 8px;
    }
    #gameWrap{ position:relative; height:440px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-radius:16px; overflow:hidden;}
    #lane{ position:absolute; inset:0; }
    .word{
      position:absolute; left:50%; transform:translateX(-50%);
      padding:8px 12px; border-radius:999px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.14);
      font-weight:900; letter-spacing:.5px; user-select:none; white-space:nowrap;
      backdrop-filter: blur(6px);
    }
    #floor{
      position:absolute; left:0; right:0; bottom:0; height:54px;
      border-top:1px dashed rgba(255,255,255,.20);
      display:flex; align-items:center; justify-content:center;
      font-size:12px; color:rgba(234,240,255,.7); background:rgba(0,0,0,.15);
    }
    .monoBox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius: 12px; width:100%; box-sizing:border-box;
      line-height:1.5; font-size:12px;
    }
    .brailleGrid{ display:grid; grid-template-columns: repeat(2, 22px); grid-template-rows: repeat(3, 22px); gap:8px; }
    .dot{ width:22px; height:22px; border-radius:999px; border:1px solid rgba(255,255,255,.20); background: rgba(255,255,255,.06); }
    .dot.on{ background: rgba(96,165,250,.55); border-color: rgba(96,165,250,.75); }
    textarea{
      width:100%; min-height: 240px; resize: vertical;
      border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25); color:#eaf0ff; padding:10px 12px; box-sizing:border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
    }
    .hint{ color: rgba(234,240,255,.72); font-size:12px; line-height:1.5; margin-top:10px; }
    .ok{ color: rgba(110,231,183,.95); }
    .warn{ color: rgba(251,191,36,.95); }
  </style>
</head>
<body>
<header>
  <div class="pill">입력키: 1~6점 = F D S / J K L</div>
  <div class="pill">셀 확정: 키를 모두 떼면 1셀 입력</div>
  <div class="pill">채점: Enter (가장 아래 단어)</div>
  <div class="pill">삭제: Backspace</div>
  <div class="pill">일시정지: Space</div>
</header>

<main>
  <section class="card">
    <h2>게임</h2>
    <div class="content">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div class="pill">
          점수: <b id="score">0</b> /
          콤보: <b id="combo">0</b> /
          라이프: <b id="life">3</b>
        </div>
        <div class="row">
          <button class="btn primary" id="startBtn">시작</button>
          <button class="btn" id="resetBtn">리셋</button>
        </div>
      </div>

      <div class="row" style="justify-content:space-between; margin:10px 0 12px;">
        <div class="row">
          <label class="pill">모드
            <select id="modeSel" style="margin-left:8px;">
              <option value="game" selected>게임</option>
              <option value="practice">연습</option>
            </select>
          </label>
          <label class="pill">난이도
            <select id="diffSel" style="margin-left:8px;">
              <option value="easy">쉬움</option>
              <option value="normal" selected>보통</option>
              <option value="hard">어려움</option>
            </select>
          </label>
        </div>
        <label class="pill">속도
          <input id="speedRange" type="range" min="0.6" max="2.2" step="0.1" value="1.0" style="vertical-align:middle; width:160px; margin:0 8px;">
          <b id="speedLabel">x1.0</b>
        </label>
      </div>

      <div id="gameWrap">
        <div id="lane"></div>
        <div id="floor">바닥 도착 = (게임모드) 라이프 -1</div>
      </div>

      <div style="margin-top:12px;">
        <div class="monoBox" id="typingBox"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>입력 상태 / 문제 데이터</h2>
    <div class="content">
      <div class="pill">현재 누르고 있는 점(셀)</div>

      <div class="row" style="margin-top:10px; gap:14px;">
        <div class="brailleGrid" id="dots">
          <div class="dot" data-dot="1"></div>
          <div class="dot" data-dot="4"></div>
          <div class="dot" data-dot="2"></div>
          <div class="dot" data-dot="5"></div>
          <div class="dot" data-dot="3"></div>
          <div class="dot" data-dot="6"></div>
        </div>
        <div class="pill">현재 셀(1→6): <b id="cellBits">000000</b></div>
      </div>

      <div class="hint">
        <b>문제 데이터(JSON)</b><br/>
        키=단어, 값=6비트 셀열(공백으로 구분).<br/>
        예: <code>"그림자": "000100 111000 001010 ..."</code><br/>
        (여기 데이터는 네가 만든 표 기준으로 넣으면 됨)
      </div>

      <textarea id="dataArea"></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="applyDataBtn">데이터 적용</button>
        <span class="hint warn" id="dataMsg"></span>
      </div>
    </div>
  </section>
</main>

<script>
/** 키 -> 점 매핑 */
const KEY_TO_DOT = { 'f':1, 'd':2, 's':3, 'j':4, 'k':5, 'l':6 };

let running = false;
let paused = false;

let score = 0;
let combo = 0;
let life = 3;

const laneEl = document.getElementById('lane');
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const lifeEl = document.getElementById('life');
const typingBox = document.getElementById('typingBox');

const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');

const dotsEl = document.getElementById('dots');
const cellBitsEl = document.getElementById('cellBits');

const dataArea = document.getElementById('dataArea');
const applyDataBtn = document.getElementById('applyDataBtn');
const dataMsg = document.getElementById('dataMsg');

const modeSel = document.getElementById('modeSel');
const diffSel = document.getElementById('diffSel');
const speedRange = document.getElementById('speedRange');
const speedLabel = document.getElementById('speedLabel');

/** 설정 */
let SETTINGS = {
  mode: 'game',          // game | practice
  difficulty: 'normal',  // easy | normal | hard
  speedMult: 1.0,
  spawnInterval: 1.1,
  baseFall: 70,
  lives: 3,
  maxOnScreen: 6
};

function applyPreset(){
  const d = SETTINGS.difficulty;
  if(d === 'easy'){
    SETTINGS.spawnInterval = 1.6;
    SETTINGS.baseFall = 55;
    SETTINGS.lives = 5;
    SETTINGS.maxOnScreen = 4;
  } else if(d === 'normal'){
    SETTINGS.spawnInterval = 1.1;
    SETTINGS.baseFall = 70;
    SETTINGS.lives = 3;
    SETTINGS.maxOnScreen = 6;
  } else {
    SETTINGS.spawnInterval = 0.8;
    SETTINGS.baseFall = 90;
    SETTINGS.lives = 2;
    SETTINGS.maxOnScreen = 8;
  }

  if(SETTINGS.mode === 'practice'){
    life = 999;
  } else {
    life = SETTINGS.lives;
  }
  setHud();
}

function syncUI(){
  speedLabel.textContent = `x${Number(SETTINGS.speedMult).toFixed(1)}`;
}
modeSel.addEventListener('change', () => {
  SETTINGS.mode = modeSel.value;
  applyPreset();
  renderTyping('모드 변경됨.');
});
diffSel.addEventListener('change', () => {
  SETTINGS.difficulty = diffSel.value;
  applyPreset();
  renderTyping('난이도 적용됨.');
});
speedRange.addEventListener('input', () => {
  SETTINGS.speedMult = Number(speedRange.value);
  syncUI();
});

/** 데이터 (기본값 예시 — 네가 적용 버튼으로 바꿀 수 있음) */
let WORD_DB = {
  "학교": "010110 000100 000100 000100",
  "그림자": "000100 010101 000010 101010110 100000 000100 001101010 010001 000101",
  "연습": "100001 000001 010101 110000",
  "스불재": "000001 010101 000110 101100 010000 000101 111010", 
  "게놈": "100001 000001 010101 110000",
  "이수아": "101010 000001 101100 110001",
  "제주도민": "000101 101110 000101 101100 010100 101001 100010 101010 010010",
  "바보": "000110 000110 101001"
};

function refreshDataArea(){
  dataArea.value = JSON.stringify(WORD_DB, null, 2);
}
refreshDataArea();

/** 유틸 */
function parseAnswerCells(str){
  return String(str).trim().split(/\s+/).filter(Boolean);
}
function setHud(){
  scoreEl.textContent = score;
  comboEl.textContent = combo;
  lifeEl.textContent = life >= 900 ? '∞' : life;
}
function bitsFromDots(dotSet){
  // ✅ 네 규칙: 1→2→3→4→5→6 순서로 0/1
  let bits = '';
  for(let d=1; d<=6; d++) bits += dotSet.has(d) ? '1' : '0';
  return bits;
}
function renderHeldDots(){
  const bits = bitsFromDots(heldDots);
  cellBitsEl.textContent = bits;
  [...dotsEl.querySelectorAll('.dot')].forEach(dot => {
    const d = Number(dot.dataset.dot);
    dot.classList.toggle('on', heldDots.has(d));
  });
}

/** 입력 버퍼 */
let inputCells = [];
let heldDots = new Set();
let heldKeys = new Set();

/** 활성 단어들 */
let activeWords = []; // {text, y, speed, el, answerCells[]}

let spawnTimer = 0;
let lastT = performance.now();

function getUrgentWord(){
  if(activeWords.length === 0) return null;
  return activeWords.reduce((a,b) => (a.y > b.y ? a : b));
}

function resetInput(){
  inputCells = [];
  heldDots.clear();
  heldKeys.clear();
  renderHeldDots();
  renderTyping();
}

function renderTyping(msg=''){
  const target = getUrgentWord();
  const targetText = target ? target.text : '(단어 없음)';
  const targetCells = target ? target.answerCells : [];

  // ✅ "일반 글자 진행도 표시" (입력 셀 개수만큼 단어 글자 보여주기)
  const typedCount = inputCells.length;
  const chars = Array.from(targetText);
  const shown = target ? chars.slice(0, Math.min(typedCount, chars.length)).join('') : '';

  // prefix 검사(틀린 지점 빨리 표시)
  let prefixOk = true;
  for(let i=0; i<inputCells.length && i<targetCells.length; i++){
    if(inputCells[i] !== targetCells[i]) { prefixOk = false; break; }
  }
  const badge = target
    ? (prefixOk ? `<span class="ok">● 진행 OK</span>` : `<span class="warn">● 여기서부터 틀렸을 수 있음</span>`)
    : '';

  typingBox.innerHTML = `
    <div><b>채점 대상(가장 아래)</b>: ${targetText}</div>
    <div style="margin-top:6px;"><b>입력 진행(일반 글자)</b>: ${shown || '(아직 없음)'} ${badge}</div>
    <div style="margin-top:6px;"><b>입력한 셀열</b>: ${inputCells.join(' ') || '(비어있음)'}</div>
    ${msg ? `<div style="margin-top:6px;"><small>${msg}</small></div>`
         : `<div style="margin-top:6px;"><small>키를 모두 떼면 1셀 확정. Enter로 채점.</small></div>`}
  `;
}

/** 단어 생성 */
function spawnWord(){
  const keys = Object.keys(WORD_DB);
  if(keys.length === 0) return;

  const text = keys[Math.floor(Math.random() * keys.length)];
  const answerCells = parseAnswerCells(WORD_DB[text]);

  const el = document.createElement('div');
  el.className = 'word';
  el.textContent = text;
  el.style.top = '-10px';
  laneEl.appendChild(el);

  activeWords.push({
    text,
    y: -10,
    speed: (SETTINGS.baseFall + Math.random()*45 + Math.min(120, score/20)) * SETTINGS.speedMult,
    el,
    answerCells
  });
}

function removeWord(w){
  const idx = activeWords.indexOf(w);
  if(idx >= 0) activeWords.splice(idx, 1);
  w.el?.remove?.();
}

function loseLife(){
  if(SETTINGS.mode !== 'game') return;
  life -= 1;
  combo = 0;
  setHud();
  if(life <= 0){
    running = false;
    paused = false;
    alert('게임 오버! 리셋하거나 다시 시작해줘.');
  }
}

/** 채점 */
function judge(){
  const target = getUrgentWord();
  if(!target) return;

  const user = inputCells.join(' ').trim();
  const ans = target.answerCells.join(' ').trim();

  if(user === ans){
    score += 120 + combo*15;
    combo += 1;
    removeWord(target);
    resetInput();
    renderTyping('정답! 단어 제거됨.');
  } else {
    combo = 0;
    score = Math.max(0, score - 30);
    resetInput();
    renderTyping('오답. 입력 초기화됨.');
  }
  setHud();
}

/** 일시정지 */
function togglePause(){
  if(!running) return;
  paused = !paused;
  renderTyping(paused ? '일시정지' : '재개');
}

/** 루프 */
function tick(t){
  const dt = (t - lastT) / 1000;
  lastT = t;

  if(running && !paused){
    // 스폰
    if(SETTINGS.mode === 'game'){
      spawnTimer += dt;
      if(spawnTimer >= SETTINGS.spawnInterval){
        spawnTimer = 0;
        if(activeWords.length < SETTINGS.maxOnScreen) spawnWord();
      }
    } else {
      if(activeWords.length === 0) spawnWord();
    }

    // 이동
    for(const w of activeWords){
      w.y += w.speed * dt;
      w.el.style.top = w.y + 'px';
    }

    // 바닥 처리
    const floorY = 440 - 54 - 28;
    const hit = activeWords.filter(w => w.y >= floorY);
    if(hit.length){
      for(const w of hit){
        removeWord(w);
      }
      resetInput();
      if(SETTINGS.mode === 'game'){
        loseLife();
        renderTyping('바닥 도착! 라이프 -1');
      } else {
        renderTyping('연습 모드: 바닥 도착 → 다음 단어');
      }
    }
  }

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/** 입력 이벤트 */
window.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();

  if(k === ' '){ e.preventDefault(); togglePause(); return; }
  if(k === 'enter'){ e.preventDefault(); judge(); return; }

  if(k === 'backspace'){
    e.preventDefault();
    inputCells.pop();
    renderTyping('마지막 셀 삭제됨.');
    return;
  }

  if(KEY_TO_DOT[k]){
    e.preventDefault();
    heldKeys.add(k);
    heldDots.add(KEY_TO_DOT[k]);
    renderHeldDots();
  }
});

window.addEventListener('keyup', (e) => {
  const k = e.key.toLowerCase();
  if(KEY_TO_DOT[k]){
    e.preventDefault();
    heldKeys.delete(k);
    // ✅ 키를 모두 떼는 순간 1셀 확정
    if(heldKeys.size === 0){
      const bits = bitsFromDots(heldDots);
      if(bits !== '000000') inputCells.push(bits);
      heldDots.clear();
      renderHeldDots();
      renderTyping();
    }
  }
});

/** 버튼 */
startBtn.addEventListener('click', () => {
  if(!running){
    running = true;
    paused = false;
    spawnTimer = 0;
    if(activeWords.length === 0) spawnWord();
  } else {
    paused = false;
  }
  renderTyping();
});

resetBtn.addEventListener('click', () => {
  running = false;
  paused = false;
  score = 0; combo = 0;
  activeWords.forEach(w => w.el?.remove?.());
  activeWords = [];
  spawnTimer = 0;
  resetInput();

  applyPreset();
  setHud();
  renderTyping('리셋 완료.');
});

/** 데이터 적용 */
applyDataBtn.addEventListener('click', () => {
  try{
    const obj = JSON.parse(dataArea.value);

    for(const [w, v] of Object.entries(obj)){
      if(typeof w !== 'string' || !w.trim()) throw new Error('단어 키가 비었어.');
      if(typeof v !== 'string') throw new Error(`"${w}"의 값은 문자열이어야 해.`);
      const cells = parseAnswerCells(v);
      if(cells.length === 0) throw new Error(`"${w}" 값이 비어있어.`);
      for(const c of cells){
        if(!/^[01]{6}$/.test(c)) throw new Error(`"${w}"에 6비트(0/1) 형식이 아닌 셀이 있어: ${c}`);
      }
    }

    WORD_DB = obj;
    dataMsg.textContent = '적용 완료!';
    setTimeout(()=>dataMsg.textContent='', 1200);
    renderTyping('데이터 적용됨.');
  } catch(err){
    dataMsg.textContent = '오류: ' + err.message;
  }
});

/** 초기화 */
applyPreset();
syncUI();
setHud();
renderHeldDots();
renderTyping();
</script>
</body>
</html>
