
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì ì íƒ€ì ê²Œì„</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --text:#eaf0ff; --muted:rgba(234,240,255,.72);
      --ok:#6ee7b7; --warn:#fbbf24; --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
    header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .wrap{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px}
    .content{padding:12px}
    .btn{
      cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10); color:var(--text);
    }
    .btn.primary{background:rgba(110,231,183,.18);border-color:rgba(110,231,183,.35)}
    .btn.danger{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.18);font-weight:800}
    .muted{color:var(--muted);font-size:12px;line-height:1.45}
    .ok{color:var(--ok);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .bad{color:var(--bad);font-weight:900}

    /* Game area */
    #gameBox{
      position:relative; height:420px; border-radius:16px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
    }
    #floor{
      position:absolute; left:0; right:0; bottom:0; height:40px;
      border-top:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; padding:0 10px;
    }
    #falling{
      position:absolute; left:50%; transform:translateX(-50%);
      top:16px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      font-weight:900;
      min-width:120px;
      text-align:center;
      pointer-events:none;
      white-space:nowrap;
    }
    #falling small{display:block;font-weight:700;color:var(--muted);margin-top:4px}

    /* Input & braille preview */
    #typedRaw{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      width:100%;
      color:var(--text);
      min-height:42px;
      white-space:pre-wrap;
    }
    .brailleRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .cell{
      width:30px;height:44px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      display:grid;grid-template-columns:repeat(2, 1fr);
      grid-template-rows:repeat(3, 1fr);
      padding:6px;gap:4px;
    }
    .dot{
      border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
    }
    .dot.on{background:rgba(234,240,255,.9)}

    /* Modal */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(820px, 100%);
      background:rgba(15,20,35,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      overflow:hidden;
    }
    .modal header{border-bottom:1px solid rgba(255,255,255,.12)}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:620px){ .grid{grid-template-columns:1fr} }
    .slider{display:flex;align-items:center;gap:10px}
    input[type="range"]{width:240px}
  </style>
</head>
<body>

<header>
  <div class="row">
    <div class="pill" id="modePill">ëª¨ë“œ: -</div>
    <div class="pill" id="catPill">ì¹´í…Œê³ ë¦¬: -</div>
    <div class="pill">ì ìˆ˜: <span id="score">0</span></div>
    <div class="pill" id="levelWrap" style="display:none">ë‹¨ê³„: <span id="level">1</span></div>
    <div class="pill" id="heartsWrap" style="display:none">â™¥ <span id="hearts">5</span></div>
  </div>
  <div class="row">
    <button class="btn" id="openMenuBtn">ë©”ë‰´</button>
    <button class="btn danger" id="resetBtn">ë¦¬ì…‹</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>ê²Œì„</h2>
    <div class="content">
      <div id="gameBox" aria-label="ê²Œì„ í™”ë©´">
        <div id="falling">
          <div id="fallText">-</div>
          <small id="fallHint">Space/Enterë¡œ ì œì¶œ</small>
        </div>
        <div id="floor">
          <div class="muted">ë°”ë‹¥ ë„ì°© = ì‹¤íŒ¨</div>
          <div class="muted">ì…ë ¥: 0/1, ë°±ìŠ¤í˜ì´ìŠ¤, Space/Enter(ì œì¶œ)</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1;min-width:260px">
          <div class="muted">ì…ë ¥í•œ ì…€ì—´(ì›ë¬¸) â€” 6ìë¦¬ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì…€ì´ ë‚˜ë‰˜ì–´</div>
          <div id="typedRaw"> </div>
          <div class="muted" style="margin-top:6px">í•œê¸€ í•´ì„</div>
<div id="typedHangul" class="pill" style="min-height:32px"> </div>

          <div class="muted" style="margin-top:8px">ì…ë ¥í•œ ì ì(ë¯¸ë¦¬ë³´ê¸°)</div>
          <div id="braillePreview" class="brailleRow" aria-label="ì ì ë¯¸ë¦¬ë³´ê¸°"></div>
        </div>

        <div style="min-width:280px;flex:0 0 320px">
          <div class="card" style="margin:0">
            <h2>ì„¤ì •</h2>
            <div class="content">
              <div class="muted">ì—°ìŠµ ëª¨ë“œì—ì„œë§Œ ì†ë„ ì¡°ì ˆ ê°€ëŠ¥</div>
              <div class="slider" style="margin-top:10px">
                <span class="pill">ì†ë„</span>
                <input id="speedRange" type="range" min="30" max="220" value="90" />
                <span class="pill" id="speedVal">90</span>
              </div>
              <div class="muted" style="margin-top:10px">
                * ê²Œì„ ëª¨ë“œì—ì„œëŠ” ë‹¨ê³„ê°€ ì˜¤ë¥¼ ë•Œ ìë™ìœ¼ë¡œ ë¹¨ë¼ì§
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="startBtn">ì‹œì‘</button>
                <button class="btn" id="stopBtn">ì •ì§€</button>
              </div>
              <div class="muted" style="margin-top:10px">
                ì œì¶œ í‚¤: <b>Space ë˜ëŠ” Enter</b>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Menu Modal -->
<div class="overlay" id="menuOverlay">
  <div class="modal">
    <header>
      <div style="font-weight:950">ë©”ë‰´</div>
      <button class="btn" id="closeMenuBtn">ë‹«ê¸°</button>
    </header>
    <div class="content">
      <div class="card" style="margin:0 0 12px 0">
        <h2>1) ëª¨ë“œ ì„ íƒ</h2>
        <div class="content">
          <div class="grid">
            <button class="btn primary" id="pickPractice">
              ì—°ìŠµ ëª¨ë“œ<br/><span class="muted">ì†ë„ ì¡°ì ˆ ê°€ëŠ¥ / ë§ìœ¼ë©´ +, ë†“ì¹˜ë©´ -</span>
            </button>
            <button class="btn primary" id="pickGame">
              ê²Œì„ ëª¨ë“œ<br/><span class="muted">ë‹¨ê³„ ìƒìŠ¹ / í•˜íŠ¸ 5ê°œ / ê²Œì„ì˜¤ë²„</span>
            </button>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <h2>2) ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì—°ìŠµ/ê²Œì„ ê³µí†µ)</h2>
        <div class="content">
          <div class="grid" id="catGrid"></div>
          <div class="muted" style="margin-top:10px">
            ì¹´í…Œê³ ë¦¬ ì„ íƒ í›„ <b>ì‹œì‘</b>ì„ ëˆ„ë¥´ë©´ ì‹œì‘ë¼.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div class="overlay" id="overOverlay">
  <div class="modal">
    <header>
      <div style="font-weight:950">ê²Œì„ ì˜¤ë²„</div>
      <button class="btn" id="closeOverBtn">ë‹«ê¸°</button>
    </header>
    <div class="content">
      <div class="mono">ì´ë²ˆ ê²Œì„ ì ìˆ˜: <span class="ok" id="finalScore">0</span></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="retryBtn">ë‹¤ì‹œí•˜ê¸° (1ë‹¨ê³„)</button>
        <button class="btn" id="backToMenuBtn">ë©”ë‰´ë¡œ</button>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 * ì¹´í…Œê³ ë¦¬
 * ========================= */
const CATEGORIES = ["ì´ˆì„±","ì¢…ì„±","ëª¨ìŒ","ì•½ì","ë¶€í˜¸","ìˆ«ì","ì˜ì–´","ë‹¨ì–´"];

/** =========================
 * ë¬¸ì œ ë°ì´í„° (ë„ˆê°€ ì¤€ í‘œ ê·¸ëŒ€ë¡œ ë°˜ì˜)
 * cellsëŠ” "ì…€ì—´" ë¬¸ìì—´
 * ========================= */
const BANK = {
  "ì´ˆì„±": [
    { text:"ã„±", cells:"000100" },
    { text:"ã„´", cells:"100100" },
    { text:"ã„·", cells:"010100" },
    { text:"ã„¹", cells:"000010" },
    { text:"ã…", cells:"100010" },
    { text:"ã…‚", cells:"000110" },
    { text:"ã……", cells:"000001" },
    // ã…‡ì€ ì´ˆì„± ìƒëµì´ë¼ â€˜ì´ˆì„±â€™ ì¹´í…Œê³ ë¦¬ì—ì„œ êµ³ì´ ì•ˆ ë„£ìŒ
    { text:"ã…ˆ", cells:"000101" },
    { text:"ã…Š", cells:"000011" },
    { text:"ã…‹", cells:"110100" },
    { text:"ã…Œ", cells:"110010" },
    { text:"ã…", cells:"100110" },
    { text:"ã…", cells:"010110" },
    { text:"ã„²", cells:"000001 000100" },
    { text:"ã„¸", cells:"000001 010100" },
    { text:"ã…ƒ", cells:"000001 000110" },
    { text:"ã…†(ì´ˆì„±)", cells:"000001 000001" },
    { text:"ã…‰", cells:"000001 000101" },
  ],
  "ì¢…ì„±": [
    { text:"ã„±", cells:"100000" },
    { text:"ã„´", cells:"010010" },
    { text:"ã„·", cells:"001010" },
    { text:"ã„¹", cells:"010000" },
    { text:"ã…", cells:"010001" },
    { text:"ã…‚", cells:"110000" },
    { text:"ã……", cells:"001000" },
    { text:"ã…‡", cells:"011011" },
    { text:"ã…ˆ", cells:"101000" },
    { text:"ã…Š", cells:"011000" },
    { text:"ã…‹", cells:"011010" },
    { text:"ã…Œ", cells:"011001" },
    { text:"ã…", cells:"010011" },
    { text:"ã…", cells:"001011" },
  ],
  "ëª¨ìŒ": [
    { text:"ã…", cells:"110001" },
    { text:"ã…‘", cells:"001110" },
    { text:"ã…“", cells:"011100" },
    { text:"ã…•", cells:"100011" },
    { text:"ã…—", cells:"101001" },
    { text:"ã…›", cells:"001101" },
    { text:"ã…œ", cells:"101100" },
    { text:"ã… ", cells:"100101" },
    { text:"ã…¡", cells:"010101" },
    { text:"ã…£", cells:"101010" },
    { text:"ã…", cells:"111010" },
    { text:"ã…”", cells:"101110" },
    { text:"ã…š", cells:"101111" },
    { text:"ã…˜", cells:"111001" },
    { text:"ã…", cells:"111100" },
    { text:"ã…¢", cells:"010111" },
    { text:"ã…–", cells:"001100" },
    { text:"ã…Ÿ", cells:"101100 111010" },
    { text:"ã…’", cells:"001110 111010" },
    { text:"ã…™", cells:"111001 111010" },
    { text:"ã…", cells:"111100 111010" },
  ],
  "ì•½ì": [
    { text:"ê°€", cells:"110101" },
    { text:"ë‚˜", cells:"100100" },
    { text:"ë‹¤", cells:"010100" },
    { text:"ë§ˆ", cells:"100010" },
    { text:"ë°”", cells:"000110" },
    { text:"ì‚¬", cells:"111000" },
    { text:"ì", cells:"000101" },
    { text:"ì¹´", cells:"110100" },
    { text:"íƒ€", cells:"110010" },
    { text:"íŒŒ", cells:"100110" },
    { text:"í•˜", cells:"010110" },
    { text:"ê²ƒ", cells:"000111 011100" },
    { text:"ã…†", cells:"001100" },
    { text:"ì–µ", cells:"100111" },
    { text:"ì–¸", cells:"011111" },
    { text:"ì–¼", cells:"011110" },
    { text:"ì—°", cells:"100001" },
    { text:"ì—´", cells:"110011" },
    { text:"ì˜", cells:"110111" },
    { text:"ì˜¥", cells:"101101" },
    { text:"ì˜¨", cells:"111011" },
    { text:"ì˜¹", cells:"111111" },
    { text:"ìš´", cells:"110110" },
    { text:"ìš¸", cells:"111101" },
    { text:"ì€", cells:"101011" },
    { text:"ì„", cells:"011101" },
    { text:"ì¸", cells:"111110" },
    { text:"ê·¸ë˜ì„œ", cells:"100000 011100" },
    { text:"ê·¸ëŸ¬ë‚˜", cells:"100000 100100" },
    { text:"ê·¸ëŸ¬ë©´", cells:"100000 010010" },
    { text:"ê·¸ëŸ¬ë¯€ë¡œ", cells:"100000 010001" },
    { text:"ê·¸ëŸ°ë°", cells:"100000 101110" },
    { text:"ê·¸ë¦¬ê³ ", cells:"100000 101001" },
  ],
  "ë¶€í˜¸": [
    { text:".", cells:"010011" },
    { text:"?", cells:"011001" },
    { text:"!", cells:"011010" },
    { text:",", cells:"000010" },
    { text:"Â·", cells:"000010 011000" },
    { text:":", cells:"000010 010000" },
    { text:";", cells:"000011 011000" },
    { text:"â€œ", cells:"011001" },
    { text:"â€", cells:"001011" },
    { text:"â€˜", cells:"000001 011001" },
    { text:"â€™", cells:"001011 001000" },
    { text:"(", cells:"011001 001000" },
    { text:")", cells:"000001 001011" },
    { text:"{", cells:"011001 011000" },
    { text:"}", cells:"000010 001011" },
    { text:"[", cells:"011001 011000" },
    { text:"]", cells:"000011 001011" },
    { text:"-(ë¶™ì„í‘œ)", cells:"001001" },
    { text:"-(ì¤„í‘œ)", cells:"001001 001001" },
    { text:"~", cells:"000100 001010" },
    { text:"ï½¢", cells:"000010 011001" },
    { text:"ï½£", cells:"001011 010000" },
    { text:"ã€", cells:"000011 011001" },
    { text:"ã€", cells:"001011 011000" },
    { text:"Â·Â·Â·Â·Â·Â·", cells:"000001 000001 000001" },
    { text:"â€¦â€¦", cells:"010011 010011 010011" },
    { text:"*", cells:"000010 001010" },
    { text:"â€»", cells:"000010 001010" },

    { text:"ë‹¨ìœ„í‘œ", cells:"001011" },
    { text:"%", cells:"111100" },
    { text:"â„ƒ", cells:"100110 000001 100100" },
    { text:"Â°", cells:"100110" },

    { text:",(ìë¦¿ê°’)", cells:"010000" },
    { text:"+", cells:"010001" },
    { text:"-(ì—°ì‚°)", cells:"001010" },
    { text:"Ã—", cells:"100001" },
    { text:"Ã·", cells:"001100 001100" },
    { text:"=", cells:"010010 010010" },
    { text:"(. ê´„í˜¸ì—´)", cells:"011001" },
    { text:")(. ê´„í˜¸ë‹«)", cells:"001011" },
    { text:".(ì†Œìˆ˜ì )", cells:"010011" },
    { text:"-(ë¶„ìˆ˜í‘œ)", cells:"001100" },
  ],
  "ìˆ«ì": [
    { text:"ìˆ˜í‘œ", cells:"001111" },
    { text:"1", cells:"100000" },
    { text:"2", cells:"110000" },
    { text:"3", cells:"100100" },
    { text:"4", cells:"100110" },
    { text:"5", cells:"100010" },
    { text:"6", cells:"110100" },
    { text:"7", cells:"110110" },
    { text:"8", cells:"110010" },
    { text:"9", cells:"010100" },
    { text:"0", cells:"010110" },
  ],
  "ì˜ì–´": [
    { text:"ë¡œë§ˆìí‘œ", cells:"001011" },
    { text:"ë¡œë§ˆìì¢…ë£Œí‘œ", cells:"010011" },
    { text:"ëŒ€ë¬¸ìê¸°í˜¸í‘œ", cells:"000001" },
    { text:"ëŒ€ë¬¸ìë‹¨ì–´í‘œ", cells:"000001 000001" },
    { text:"ëŒ€ë¬¸ìêµ¬ì ˆí‘œ", cells:"000001 000001 000001" },
    { text:"ëŒ€ë¬¸ìì¢…ë£Œí‘œ", cells:"000001 001000" },
    { text:"a", cells:"100000" },
    { text:"b", cells:"110000" },
    { text:"c", cells:"100100" },
    { text:"d", cells:"100110" },
    { text:"e", cells:"100010" },
    { text:"f", cells:"110100" },
    { text:"g", cells:"110110" },
    { text:"h", cells:"110010" },
    { text:"i", cells:"010100" },
    { text:"j", cells:"010110" },
    { text:"k", cells:"101000" },
    { text:"l", cells:"111000" },
    { text:"m", cells:"101100" },
    { text:"n", cells:"101110" },
    { text:"o", cells:"101010" },
    { text:"p", cells:"111100" },
    { text:"q", cells:"111110" },
    { text:"r", cells:"111010" },
    { text:"s", cells:"011100" },
    { text:"t", cells:"011110" },
    { text:"u", cells:"101001" },
    { text:"v", cells:"111001" },
    { text:"w", cells:"010111" },
    { text:"x", cells:"101101" },
    { text:"y", cells:"101111" },
    { text:"z", cells:"101011" },
  ],
  "ë‹¨ì–´": [
    { text:"ë°”ëŒ", cells:"000110 000010 110001 010001" },
    { text:"êµ¬ë¦„", cells:"000100 101100 000010 010101 010001" },
    { text:"ì—°í•„", cells:"100001 100110 101010 010000" },
    { text:"ë…¸ì„", cells:"100100 101001 011101" },
    { text:"ê³ ë˜", cells:"000100 101001 000010 111010" },
    { text:"ë³„ë¹›", cells:"000110 110001 000110 101010 011000" },
    { text:"íŒŒë„", cells:"100110 010100 101001" },
    { text:"ì‚°ì±…", cells:"111000 010010 000011 111010 100000" },
    { text:"ìš°ì‚°", cells:"101100 111000 010010" },
    { text:"ë‹¬ê±€", cells:"010100 010000 000100 001110 010000" },
    { text:"ì´ˆë¡", cells:"000011 101001 000010 101101" },
    { text:"ì‹œê°„í‘œ", cells:"000001 101010 110101 010010 100110 001101" },
    { text:"ë°”ìœ„", cells:"000110 110001 101100 111010" },
    { text:"ì¢…ì†Œë¦¬", cells:"000101 111111 000001 101001 000010 101010" },
    { text:"ì°½ë¬¸", cells:"000011 110001 011011 100010 110110" },
    { text:"ì§€ìš°ê°œ", cells:"000101 101010 101100 000100 111010" },
    { text:"ë‚™ì—½", cells:"100100 100000 100011 110000" },
    { text:"ë¶ˆê½ƒ", cells:"000110 111101 000001 000100 101001 011000" },
    { text:"ì§€ë„", cells:"000101 101010 010100 101001" },
    { text:"ì—´ì‡ ", cells:"110011 000001 101111" },
    { text:"í˜¸ìˆ˜", cells:"010110 101001 000001 101100" },
    { text:"ë¹™í•˜", cells:"000110 101010 011011 010110" },
    { text:"ê¸°ì°¨ì—­", cells:"000100 101010 000011 110001 100011 100000" },
    { text:"ê°€ë°©ëˆ", cells:"110101 000110 011011 000001 000100 101011" },
    { text:"ì†Œë‚˜ê¸°", cells:"000001 101001 100100 000100 101010" },
    { text:"ë²ˆê°œ", cells:"000110 011111 000100 111010" },
    { text:"í­í’ìš°", cells:"100110 101101 100110 101100 011011 101100" },
  ],
};

/** =========================
 * ìƒíƒœ
 * ========================= */
const state = {
  mode: null,          // "practice" | "game"
  category: null,
  running: false,
  score: 0,
  level: 1,
  hearts: 5,

  current: null,
  y: 16,
  speed: 90,

  typed: "",           // "000101 110001" í˜•ì‹ (ìë™ìœ¼ë¡œ ê³µë°± ì‚½ì…)
};

const UI = {
  modePill: document.getElementById("modePill"),
  catPill: document.getElementById("catPill"),
  score: document.getElementById("score"),
  levelWrap: document.getElementById("levelWrap"),
  level: document.getElementById("level"),
  heartsWrap: document.getElementById("heartsWrap"),
  hearts: document.getElementById("hearts"),

  falling: document.getElementById("falling"),
  fallText: document.getElementById("fallText"),
  fallHint: document.getElementById("fallHint"),
  gameBox: document.getElementById("gameBox"),

  typedRaw: document.getElementById("typedRaw"),
  braillePreview: document.getElementById("braillePreview"),
    typedHangul: document.getElementById("typedHangul"),

  speedRange: document.getElementById("speedRange"),
  speedVal: document.getElementById("speedVal"),

  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  resetBtn: document.getElementById("resetBtn"),

  menuOverlay: document.getElementById("menuOverlay"),
  openMenuBtn: document.getElementById("openMenuBtn"),
  closeMenuBtn: document.getElementById("closeMenuBtn"),
  pickPractice: document.getElementById("pickPractice"),
  pickGame: document.getElementById("pickGame"),
  catGrid: document.getElementById("catGrid"),

  overOverlay: document.getElementById("overOverlay"),
  finalScore: document.getElementById("finalScore"),
  retryBtn: document.getElementById("retryBtn"),
  closeOverBtn: document.getElementById("closeOverBtn"),
  backToMenuBtn: document.getElementById("backToMenuBtn"),
};

function normCells(s){
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .replace(/[^01 ]/g, "");
}
function cellsToHangul(cellsString){
  const cells = normCells(cellsString).split(" ").filter(Boolean);
  if (cells.length === 0) return "";

  // ===== í•œê¸€ ì¡°í•© í…Œì´ë¸”(ìœ ë‹ˆì½”ë“œ) =====
  const CHO  = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  const JUNG = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
  const JONG = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

  // ===== ì…€ â†’ ì´ˆì„±/ëª¨ìŒ/ì¢…ì„± ë§¤í•‘ =====
  // (ë„ˆê°€ ì“°ëŠ” ì ì ì…ë ¥ ì…€ ê¸°ì¤€. í•„ìš”í•˜ë©´ ë” ì¶”ê°€ ê°€ëŠ¥)
  const CHO_BY_CELL = {
    "000100":"ã„±","100100":"ã„´","010100":"ã„·","000010":"ã„¹","100010":"ã…","000110":"ã…‚",
    "000001":"ã……","000101":"ã…ˆ","000011":"ã…Š","110100":"ã…‹","110010":"ã…Œ","100110":"ã…","010110":"ã…",
  };

  const VOWEL_BY_CELL = {
    "110001":"ã…","111010":"ã…","001110":"ã…‘","011100":"ã…“","101110":"ã…”","100011":"ã…•",
    "101001":"ã…—","001101":"ã…›","101100":"ã…œ","100101":"ã… ","010101":"ã…¡","101010":"ã…£",
    "101111":"ã…š","111001":"ã…˜","111100":"ã…","010111":"ã…¢","001100":"ã…–"
    // ë³µí•©ëª¨ìŒ(2ì…€ì§œë¦¬)ì€ ì§€ê¸ˆ ë¡œì§ì—ì„  'â–¡' ëœ° ìˆ˜ ìˆìŒ â†’ í•„ìš”í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì—¬ì¤„ê²Œ
  };

  const JONG_BY_CELL = {
    "100000":"ã„±","010010":"ã„´","001010":"ã„·","010000":"ã„¹","010001":"ã…","110000":"ã…‚",
    "001000":"ã……","011011":"ã…‡","101000":"ã…ˆ","011000":"ã…Š","011010":"ã…‹","011001":"ã…Œ","010011":"ã…","001011":"ã…",
  };

  // ëœì†Œë¦¬: 000001 + (ã„±/ã„·/ã…‚/ã……/ã…ˆ) => ã„²/ã„¸/ã…ƒ/ã…†/ã…‰
  const TENSE_TARGET = { "ã„±":"ã„²","ã„·":"ã„¸","ã…‚":"ã…ƒ","ã……":"ã…†","ã…ˆ":"ã…‰" };

  // ===== ì•½ì/ë‹¨ì–´ ë¶„í•´ í…Œì´ë¸” =====

// 3ï¸âƒ£ ìŒì ˆ ì•½ì (ì•ì— ì´ˆì„± ì˜¤ë©´ ê²°í•©)
const SYLLABLE_ABBREV = {
  "100111":"ì–µ","011111":"ì–¸","011110":"ì–¼","100001":"ì—°","110011":"ì—´",
  "110111":"ì˜","101101":"ì˜¥","111011":"ì˜¨","111111":"ì˜¹","110110":"ìš´",
  "111101":"ìš¸","101011":"ì€","011101":"ì„","111110":"ì¸",
};

// 1ï¸âƒ£ ê³ ì • 2ì…€ ë‹¨ì–´ ì•½ì
const WORD_ABBREV = {
  "000111 011100": "ê²ƒ",
  "100000 011100": "ê·¸ë˜ì„œ",
  "100000 100100": "ê·¸ëŸ¬ë‚˜",
  "100000 010010": "ê·¸ëŸ¬ë©´",
  "100000 010001": "ê·¸ëŸ¬ë¯€ë¡œ",
  "100000 101110": "ê·¸ëŸ°ë°",
  "100000 101001": "ê·¸ë¦¬ê³ ",
};

  let result = [];
  let lastCho = null; // ì§ì „ì— ì…ë ¥ëœ ì´ˆì„±(ì•„ì§ ëª¨ìŒê³¼ ê²°í•© ì „)
  let numberMode = false;
  let englishMode = false;
  let capitalNext = false;

  const isHangulSyllable = (ch) => {
    const code = ch.charCodeAt(0);
    return code >= 0xAC00 && code <= 0xD7A3;
  };

const ABBREV_BY_CELL = {};
for (const item of BANK["ì•½ì"]) {
  ABBREV_BY_CELL[normCells(item.cells)] = item.text;
}

const SYMBOL_BY_CELL = {};
for (const item of BANK["ë¶€í˜¸"]) {
  SYMBOL_BY_CELL[normCells(item.cells)] = item.text;
}

const NUMBER_BY_CELL = {};
for (const item of BANK["ìˆ«ì"]) {
  NUMBER_BY_CELL[normCells(item.cells)] = item.text;
}

const ENGLISH_BY_CELL = {};
for (const item of BANK["ì˜ì–´"]) {
  ENGLISH_BY_CELL[normCells(item.cells)] = item.text;
}

  for (let i = 0; i < cells.length; i++) {
    const cell = cells[i];

// 0-1ï¸âƒ£ ê¸°í˜¸
if (SYMBOL_BY_CELL[cell]) {
  result.push(SYMBOL_BY_CELL[cell]);
  lastCho = null;
  tensePending = false;
  continue;
}

// 0-2ï¸âƒ£ ìˆ«ì ìˆ˜í‘œ
if (cell === "001111") {
  numberMode = true;
  continue;
}

if (numberMode) {
  const numMap = {
    "100000":"1", "110000":"2", "100100":"3", "100110":"4", "100010":"5",
    "110100":"6", "110110":"7", "110010":"8", "010100":"9", "010110":"0"
  };
  if (numMap[cell]) {
    result.push(numMap[cell]);
    continue;
  } else {
    numberMode = false; // ìˆ«ì ë
  }
}
// 0-3ï¸âƒ£ ì˜ì–´ ëª¨ë“œ
if (cell === "001011") {
  englishMode = true;
  continue;
}
if (cell === "010011" && englishMode) {
  englishMode = false;
  continue;
}
if (cell === "000001" && englishMode) {
  capitalNext = true;
  continue;
}

if (englishMode) {
  const ENG_BY_CELL = {
    "100000":"a","110000":"b","100100":"c","100110":"d","100010":"e",
    "110100":"f","110110":"g","110010":"h","010100":"i","010110":"j",
    "101000":"k","111000":"l","101100":"m","101110":"n","101010":"o",
    "111100":"p","111110":"q","111010":"r","011100":"s","011110":"t",
    "101001":"u","111001":"v","010111":"w","101101":"x","101111":"y","101011":"z"
  };
  let ch = ENG_BY_CELL[cell] || "â–¡";
  if (capitalNext) {
    ch = ch.toUpperCase();
    capitalNext = false;
  }
  result.push(ch);
  continue;
}

    // 1) âœ… 000001 ì²˜ë¦¬: "ëœì†Œë¦¬í‘œ"ì¼ ìˆ˜ë„ ìˆê³ , ê·¸ëƒ¥ "ã……"ì¼ ìˆ˜ë„ ìˆìŒ
    if (cell === "000001") {
      const nextCell = cells[i + 1];
      const nextCho = nextCell ? CHO_BY_CELL[nextCell] : null;

      // ë‹¤ìŒì´ (ã„±/ã„·/ã…‚/ã……/ã…ˆ) ì´ˆì„±ì´ë©´ ëœì†Œë¦¬í‘œë¡œ ì²˜ë¦¬
      if (nextCho && TENSE_TARGET[nextCho]) {
        // ë‹¤ìŒ ì´ˆì„±ì„ ëœì†Œë¦¬ë¡œ ë°”ê¾¸ê³ , ë‹¤ìŒ ì…€ê¹Œì§€ ì†Œë¹„
        const tenseCho = TENSE_TARGET[nextCho];
        lastCho = tenseCho;
        result.push(tenseCho);
        i++; // nextCell ì†Œë¹„
        continue;
      }

      // ê·¸ ì™¸ì—ëŠ” ê·¸ëƒ¥ ì´ˆì„± ã……
      lastCho = "ã……";
      result.push("ã……");
      continue;
    }

    // 2ï¸âƒ£-5ï¸âƒ£ âœ… 'ê²ƒ / ê·¸ë˜ì„œ ê³„ì—´' 2ì…€ lookahead ì²˜ë¦¬
const TWO_CELL_ABBREV = {
  // ê²ƒ
  "000111 011100": "ê²ƒ",

  // ê·¸ë˜ì„œ ê³„ì—´
  "100000 011100": "ê·¸ë˜ì„œ",
  "100000 100100": "ê·¸ëŸ¬ë‚˜",
  "100000 010010": "ê·¸ëŸ¬ë©´",
  "100000 010001": "ê·¸ëŸ¬ë¯€ë¡œ",
  "100000 101110": "ê·¸ëŸ°ë°",
  "100000 101001": "ê·¸ë¦¬ê³ ",
};

const nextCell = cells[i + 1];
if (nextCell) {
  const pair = cell + " " + nextCell;
  if (TWO_CELL_ABBREV[pair]) {
    result.push(TWO_CELL_ABBREV[pair]);
    lastCho = null;
    i++; // ğŸ”¥ ë‹¤ìŒ ì…€ ì†Œë¹„
    continue;
  }
}

    // 1-6) âœ… ì–µ/ì–¸/ì–¼/ì—°/ì—´/ì˜/â€¦ ì•½ì ì²˜ë¦¬
const SYLLABLE_ABBREV = {
  "100111": { vowel: "ã…“", jong: "ã„±" }, // ì–µ
  "011111": { vowel: "ã…“", jong: "ã„´" }, // ì–¸
  "011110": { vowel: "ã…“", jong: "ã„¹" }, // ì–¼
  "100001": { vowel: "ã…•", jong: "ã„´" }, // ì—°
  "110011": { vowel: "ã…•", jong: "ã„¹" }, // ì—´
  "110111": { vowel: "ã…•", jong: "ã…‡" }, // ì˜
  "101101": { vowel: "ã…—", jong: "ã„±" }, // ì˜¥
  "111011": { vowel: "ã…—", jong: "ã„´" }, // ì˜¨
  "111111": { vowel: "ã…—", jong: "ã…‡" }, // ì˜¹
  "110110": { vowel: "ã…œ", jong: "ã„´" }, // ìš´
  "111101": { vowel: "ã…œ", jong: "ã„¹" }, // ìš¸
  "101011": { vowel: "ã…¡", jong: "ã„´" }, // ì€
  "011101": { vowel: "ã…¡", jong: "ã„¹" }, // ì„
  "111110": { vowel: "ã…£", jong: "ã„´" }, // ì¸
};

if (SYLLABLE_ABBREV[cell]) {
  const { vowel, jong } = SYLLABLE_ABBREV[cell];

  // ğŸ”¹ ì•ì— ì´ˆì„±ì´ ìˆìœ¼ë©´ â†’ ê²°í•©
  if (lastCho !== null) {
    const code =
      0xAC00 +
      CHO.indexOf(lastCho) * 21 * 28 +
      JUNG.indexOf(vowel) * 28 +
      JONG.indexOf(jong);

    result[result.length - 1] = String.fromCharCode(code);
    lastCho = null;
    continue;
  }

  // ğŸ”¹ ì•ì— ì´ˆì„±ì´ ì—†ìœ¼ë©´ â†’ ê·¸ëŒ€ë¡œ ì¶œë ¥
  const code =
    0xAC00 +
    CHO.indexOf("ã…‡") * 21 * 28 +
    JUNG.indexOf(vowel) * 28 +
    JONG.indexOf(jong);

  result.push(String.fromCharCode(code));
  continue;
}

    // 1-5) âœ… 001100 ì²˜ë¦¬: ë’¤ì— ëª¨ìŒì´ë©´ ì´ˆì„± 'ã…†', ì•„ë‹ˆë©´ ëª¨ìŒ 'ã…–'
if (cell === "001100") {
  const nextCell = cells[i + 1];

  // âœ… ë’¤ì— ëª¨ìŒì´ ì˜¤ë©´: ì´ˆì„± ã…†
  if (nextCell && VOWEL_BY_CELL[nextCell]) {
    lastCho = "ã…†";
    result.push("ã…†");
    continue;
  }

  // âœ… ë’¤ì— ëª¨ìŒì´ ì•ˆ ì˜¤ë©´: ëª¨ìŒ ã…– ë¡œ ê°„ì£¼
  // (ì§ì ‘ í•©ì„±í•˜ì§€ ë§ê³ , "ëª¨ìŒ ì²˜ë¦¬ ë¸”ë¡"ì—ì„œ ì²˜ë¦¬ë˜ê²Œë”)
  // â†’ ì—¬ê¸°ì„œëŠ” cellì„ ëª¨ìŒìœ¼ë¡œ ì¸ì‹ì‹œí‚¤ê¸° ìœ„í•´ ê°•ì œë¡œ vowelë¡œ ì²˜ë¦¬
  const vowel = "ã…–";

  if (lastCho !== null) {
    const code =
      0xAC00 +
      CHO.indexOf(lastCho) * 21 * 28 +
      JUNG.indexOf(vowel) * 28;

    result[result.length - 1] = String.fromCharCode(code);
    lastCho = null;
  } else {
    const code =
      0xAC00 +
      CHO.indexOf("ã…‡") * 21 * 28 +
      JUNG.indexOf(vowel) * 28;

    result.push(String.fromCharCode(code));
  }
  continue;
}

// 2ï¸âƒ£ ì´ˆì„± / ì´ˆì„± ì•½ì ì²˜ë¦¬
if (CHO_BY_CELL[cell]) {
  const cho = CHO_BY_CELL[cell];
  const nextCell = cells[i + 1];

// 2ï¸âƒ£ ì´ˆì„± ì²˜ë¦¬
if (CHO_BY_CELL[cell]) {
  const cho = CHO_BY_CELL[cell];
  lastCho = cho;
  result.push(cho);
  continue;
}

  // ğŸ”¹ ê¸°ë³¸: ì´ˆì„±ìœ¼ë¡œ ì²˜ë¦¬
  lastCho = cho;
  result.push(cho);
  continue;
}

// 3ï¸âƒ£ ëª¨ìŒ (ë³µí•© ëª¨ìŒ ìš°ì„  ì²˜ë¦¬)
{
  const nextCell = cells[i + 1];
  let vowel = null;
  let consumed = 1;

  // ğŸ”¥ 2ì…€ì§œë¦¬ ë³µí•© ëª¨ìŒ ë¨¼ì € ì²´í¬
  if (nextCell) {
    const two = cell + " " + nextCell;
    const COMPOSITE_VOWEL = {
      "101100 111010": "ã…Ÿ",
      "001110 111010": "ã…’",
      "111001 111010": "ã…™",
      "111100 111010": "ã…",
    };
    if (COMPOSITE_VOWEL[two]) {
      vowel = COMPOSITE_VOWEL[two];
      consumed = 2;
    }
  }

  // ğŸ”¹ ë‹¨ì¼ ëª¨ìŒ
  if (!vowel && VOWEL_BY_CELL[cell]) {
    vowel = VOWEL_BY_CELL[cell];
  }

  if (vowel) {
    if (lastCho !== null) {
      // ì´ˆì„± + ëª¨ìŒ
      const code =
        0xAC00 +
        CHO.indexOf(lastCho) * 21 * 28 +
        JUNG.indexOf(vowel) * 28;

      result[result.length - 1] = String.fromCharCode(code);
      lastCho = null;
    } else {
      // ëª¨ìŒ ë‹¨ë… â†’ ã…‡ ìë™ ë³´ì¶©
      const code =
        0xAC00 +
        CHO.indexOf("ã…‡") * 21 * 28 +
        JUNG.indexOf(vowel) * 28;

      result.push(String.fromCharCode(code));
    }

    i += consumed - 1; // ğŸ”¥ 2ì…€ ëª¨ìŒì´ë©´ ë‹¤ìŒ ì…€ ì†Œë¹„
    continue;
  }
}

    // 4) âœ… ì¢…ì„±(ë°›ì¹¨)
    if (JONG_BY_CELL[cell] && result.length > 0) {
      const jong = JONG_BY_CELL[cell];
      const prev = result[result.length - 1];

      // ì§ì „ì´ ì™„ì„±ëœ í•œê¸€ ìŒì ˆì´ë©´ ë°›ì¹¨ìœ¼ë¡œ ë¶™ì´ê¸°
      if (isHangulSyllable(prev)) {
        const code = prev.charCodeAt(0) - 0xAC00;
        const choIndex  = Math.floor(code / (21 * 28));
        const jungIndex = Math.floor((code % (21 * 28)) / 28);

        const jongIndex = JONG.indexOf(jong);
        if (jongIndex >= 0) {
          const newCode = 0xAC00 + choIndex * 21 * 28 + jungIndex * 28 + jongIndex;
          result[result.length - 1] = String.fromCharCode(newCode);
          continue;
        }
      }

      // ìŒì ˆì´ ì•„ë‹ˆë©´ ê·¸ëƒ¥ ë¬¸ìë¡œ í‘œì‹œ(ì˜ˆì™¸ ì•ˆì „)
      result.push(jong);
      continue;
    }

    // 5) ì•Œ ìˆ˜ ì—†ëŠ” ì…€
    result.push("â–¡");
  }

  return result.join("");
}

function renderBraille(cellsString){
  const wrap = UI.braillePreview;
  wrap.innerHTML = "";

  const cells = normCells(cellsString).split(" ").filter(Boolean);
  for(const bits of cells){
    if(bits.length !== 6) continue;

    const cell = document.createElement("div");
    cell.className = "cell";

    const on = (idx) => bits[idx] === "1";
    const map = [0,3,1,4,2,5]; // 1,4 / 2,5 / 3,6

    for(const bi of map){
      const d = document.createElement("div");
      d.className = "dot" + (on(bi) ? " on" : "");
      cell.appendChild(d);
    }
    wrap.appendChild(cell);
  }
}

function updateHUD(){
  UI.modePill.textContent = `ëª¨ë“œ: ${state.mode ? (state.mode==="practice" ? "ì—°ìŠµ" : "ê²Œì„") : "-"}`;
  UI.catPill.textContent = `ì¹´í…Œê³ ë¦¬: ${state.category || "-"}`;
  UI.score.textContent = String(state.score);

  UI.levelWrap.style.display = (state.mode==="game") ? "inline-flex" : "none";
  UI.heartsWrap.style.display = (state.mode==="game") ? "inline-flex" : "none";
  UI.level.textContent = String(state.level);
  UI.hearts.textContent = String(state.hearts);

  UI.speedRange.disabled = !(state.mode==="practice");
  UI.speedVal.textContent = String(Number(UI.speedRange.value));
}

function setTyped(s){
  state.typed = normCells(s);

  // ì›ë¬¸(ì…€ì—´)
  UI.typedRaw.textContent = state.typed || " ";

  // ì ì ë¯¸ë¦¬ë³´ê¸°
  renderBraille(state.typed);

  // í•œê¸€ í•´ì„(ì¶”ê°€í•œ divê°€ ìˆì„ ë•Œë§Œ)
  if (UI.typedHangul) {
    UI.typedHangul.textContent = cellsToHangul(state.typed) || " ";
  }
}


/** =========================
 * ë©”ë‰´
 * ========================= */
function openMenu(){ UI.menuOverlay.classList.add("show"); }
function closeMenu(){ UI.menuOverlay.classList.remove("show"); }

function buildCategoryButtons(){
  UI.catGrid.innerHTML = "";
  for(const cat of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = cat;
    btn.onclick = () => {
      state.category = cat;
      updateHUD();
      [...UI.catGrid.querySelectorAll("button")].forEach(b=>b.classList.remove("primary"));
      btn.classList.add("primary");
    };
    UI.catGrid.appendChild(btn);
  }
}

/** =========================
 * ë¬¸ì œ ìŠ¤í°
 * ========================= */
function pickRandomItem(){
  const list = BANK[state.category] || [];
  if(list.length === 0) return null;
  const idx = Math.floor(Math.random()*list.length);
  return list[idx];
}
function spawnNew(){
  state.current = pickRandomItem();
  state.y = 16;
  setTyped("");

  if(!state.current){
    UI.fallText.textContent = "(ë°ì´í„° ì—†ìŒ)";
    return;
  }
  UI.fallText.textContent = state.current.text;
  UI.fallHint.textContent = "Space/Enterë¡œ ì œì¶œ";
  UI.falling.style.top = `${state.y}px`;
}

/** =========================
 * ì ìˆ˜/ë ˆë²¨/í•˜íŠ¸
 * ========================= */
function addScore(delta){ state.score += delta; updateHUD(); }

function loseHeart(){
  state.hearts -= 1;
  updateHUD();
  if(state.hearts <= 0) gameOver();
}

function maybeLevelUp(){
  if(state.mode !== "game") return;
  const target = 30 * state.level;
  if(state.score >= target){
    state.level += 1;
    state.speed = Math.min(220, state.speed + 15);
    updateHUD();
  }
}

/** =========================
 * ì œì¶œ(ìŠ¤í˜ì´ìŠ¤/ì—”í„°)
 * ========================= */
function submitAnswer(){
  if(!state.running || !state.current) return;

  const typed = normCells(state.typed);
  const answer = normCells(state.current.cells);

  // â€œë¯¸ì™„ì„± ì…€(6ë¹„íŠ¸ ë¯¸ë§Œ)â€ì´ë©´ ì œì¶œ ë§‰ìŒ
  const parts = typed.split(" ").filter(Boolean);
  if(parts.length === 0) return;
  if(parts[parts.length-1].length !== 6) return;

  if(typed === answer){
    addScore(+10);
    maybeLevelUp();
    spawnNew();
  }else{
    addScore(-2);
  }
}

/** =========================
 * ë£¨í”„(ë‚™í•˜)
 * ========================= */
let lastTs = 0;
function loop(ts){
  if(!state.running) return;
  if(!lastTs) lastTs = ts;
  const dt = (ts - lastTs) / 1000;
  lastTs = ts;

  const pxPerSec = (state.mode==="practice")
    ? (Number(UI.speedRange.value) / 2.0)
    : (state.speed / 2.0);

  state.y += pxPerSec * dt;
  UI.falling.style.top = `${state.y}px`;

  const floorY = UI.gameBox.clientHeight - 40 - 44;
  if(state.y >= floorY){
    if(state.mode === "practice"){
      addScore(-5);
      spawnNew();
    }else{
      loseHeart();
      spawnNew();
    }
  }

  requestAnimationFrame(loop);
}

/** =========================
 * ì‹œì‘/ì •ì§€/ë¦¬ì…‹/ê²Œì„ì˜¤ë²„
 * ========================= */
function startGame(){
  if(!state.mode || !state.category){
    openMenu();
    return;
  }
  if(state.running) return;

  state.running = true;
  lastTs = 0;

  if(state.mode === "practice"){
    state.speed = Number(UI.speedRange.value);
    state.level = 1;
    state.hearts = 5;
  }else{
    state.level = 1;
    state.hearts = 5;
    state.speed = 60;
  }

  updateHUD();
  spawnNew();
  requestAnimationFrame(loop);
}

function stopGame(){
  state.running = false;
  lastTs = 0;
}

function resetAll(){
  stopGame();
  state.score = 0;
  state.level = 1;
  state.hearts = 5;
  state.current = null;
  state.y = 16;
  setTyped("");
  UI.fallText.textContent = "-";
  updateHUD();
}

function gameOver(){
  stopGame();
  UI.finalScore.textContent = String(state.score);
  UI.overOverlay.classList.add("show");
}

function closeGameOver(){
  UI.overOverlay.classList.remove("show");
}

/** =========================
 * ì…ë ¥ (ì ì ë™ì‹œì…ë ¥ ë°©ì‹)
 * f d s = 1 2 3
 * j k l = 4 5 6
 * keyup ì‹œ 1ì…€ í™•ì •
 * Space / Enter = ì œì¶œ
 * ========================= */

// í˜„ì¬ ëˆŒë ¤ ìˆëŠ” ì ë“¤
const pressedDots = new Set();

// í‚¤ â†’ ì  ë²ˆí˜¸
const DOT_KEY_MAP = {
  f: 1, d: 2, s: 3,
  j: 4, k: 5, l: 6,
};

function handleKey(e){
  // ëª¨ë‹¬ ì—´ë ¤ ìˆìœ¼ë©´ ì…ë ¥ ë§‰ê¸°
  if (
    UI.menuOverlay.classList.contains("show") ||
    UI.overOverlay.classList.contains("show")
  ) {
    if (e.key === "Escape") {
      closeMenu();
      closeGameOver();
    }
    return;
  }

  const key = e.key.toLowerCase();

  // ì œì¶œ
  if (e.code === "Space" || e.key === "Enter") {
    e.preventDefault();
    submitAnswer();
    return;
  }

  // ë°±ìŠ¤í˜ì´ìŠ¤ â†’ ë§ˆì§€ë§‰ ì…€ ì‚­ì œ
  if (e.key === "Backspace") {
    e.preventDefault();
    const parts = state.typed.trim().split(" ").filter(Boolean);
    parts.pop();
    setTyped(parts.join(" "));
    return;
  }

  // ì ì í‚¤ ëˆŒë¦¼
  if (DOT_KEY_MAP[key]) {
    e.preventDefault();
    pressedDots.add(DOT_KEY_MAP[key]);
  }
}

// í‚¤ì—ì„œ ì† ë—„ ë•Œ = ì ì 1ì…€ í™•ì •
document.addEventListener("keyup", (e) => {
  const key = e.key.toLowerCase();
  if (!DOT_KEY_MAP[key]) return;

  if (pressedDots.size === 0) return;

  const bits = [0,0,0,0,0,0];
  pressedDots.forEach(dot => {
    bits[dot - 1] = 1;
  });

  pressedDots.clear();

  const cell = bits.join("");

  const next = state.typed
    ? state.typed + " " + cell
    : cell;

  setTyped(next);
});


/** =========================
 * ì´ë²¤íŠ¸ ë°”ì¸ë”©
 * ========================= */
UI.speedRange.addEventListener("input", ()=> {
  UI.speedVal.textContent = String(UI.speedRange.value);
  if(state.mode==="practice") state.speed = Number(UI.speedRange.value);
});

UI.startBtn.onclick = startGame;
UI.stopBtn.onclick = stopGame;
UI.resetBtn.onclick = resetAll;

UI.openMenuBtn.onclick = openMenu;
UI.closeMenuBtn.onclick = closeMenu;

UI.pickPractice.onclick = () => { state.mode="practice"; updateHUD(); };
UI.pickGame.onclick = () => { state.mode="game"; updateHUD(); };

UI.closeOverBtn.onclick = closeGameOver;
UI.backToMenuBtn.onclick = () => { closeGameOver(); openMenu(); };
UI.retryBtn.onclick = () => {
  closeGameOver();
  state.mode = "game";
  state.score = 0;
  state.level = 1;
  state.hearts = 5;
  state.speed = 60;
  updateHUD();
  startGame();
};

document.addEventListener("keydown", handleKey);

/** =========================
 * ì´ˆê¸°í™”
 * ========================= */
buildCategoryButtons();
updateHUD();
openMenu();
setTyped("");
</script>
</body>
</html>
