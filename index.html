<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>점자 타자 게임</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --text:#eaf0ff; --muted:rgba(234,240,255,.72);
      --ok:#6ee7b7; --warn:#fbbf24; --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
    header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .wrap{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px}
    .content{padding:12px}
    .btn{
      cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10); color:var(--text);
    }
    .btn.primary{background:rgba(110,231,183,.18);border-color:rgba(110,231,183,.35)}
    .btn.danger{background:rgba(251,113,133,.14);border-color:rgba(251,113,133,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.18);font-weight:800}
    .muted{color:var(--muted);font-size:12px;line-height:1.45}
    .ok{color:var(--ok);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .bad{color:var(--bad);font-weight:900}

    /* Game area */
    #gameBox{
      position:relative; height:420px; border-radius:16px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
    }
    #floor{
      position:absolute; left:0; right:0; bottom:0; height:40px;
      border-top:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; padding:0 10px;
    }
    #falling{
      position:absolute; left:50%; transform:translateX(-50%);
      top:16px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
      font-weight:900;
      min-width:120px;
      text-align:center;
      pointer-events:none;
      white-space:nowrap;
    }
    #falling small{display:block;font-weight:700;color:var(--muted);margin-top:4px}

    /* Input & braille preview */
    #typedRaw{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      width:100%;
      color:var(--text);
      min-height:42px;
      white-space:pre-wrap;
    }
    .brailleRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .cell{
      width:30px;height:44px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      display:grid;grid-template-columns:repeat(2, 1fr);
      grid-template-rows:repeat(3, 1fr);
      padding:6px;gap:4px;
    }
    .dot{
      border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
    }
    .dot.on{background:rgba(234,240,255,.9)}

    /* Modal */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(820px, 100%);
      background:rgba(15,20,35,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      overflow:hidden;
    }
    .modal header{border-bottom:1px solid rgba(255,255,255,.12)}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:620px){ .grid{grid-template-columns:1fr} }
    .slider{display:flex;align-items:center;gap:10px}
    input[type="range"]{width:240px}
  </style>
</head>
<body>

<header>
  <div class="row">
    <div class="pill" id="modePill">모드: -</div>
    <div class="pill" id="catPill">카테고리: -</div>
    <div class="pill">점수: <span id="score">0</span></div>
    <div class="pill" id="levelWrap" style="display:none">단계: <span id="level">1</span></div>
    <div class="pill" id="heartsWrap" style="display:none">♥ <span id="hearts">5</span></div>
  </div>
  <div class="row">
    <button class="btn" id="openMenuBtn">메뉴</button>
    <button class="btn danger" id="resetBtn">리셋</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>게임</h2>
    <div class="content">
      <div id="gameBox" aria-label="게임 화면">
        <div id="falling">
          <div id="fallText">-</div>
          <small id="fallHint">Space/Enter로 제출</small>
        </div>
        <div id="floor">
          <div class="muted">바닥 도착 = 실패</div>
          <div class="muted">입력: 0/1, 백스페이스, Space/Enter(제출)</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1;min-width:260px">
          <div class="muted">입력한 셀열(원문) — 6자리마다 자동으로 셀이 나뉘어</div>
          <div id="typedRaw"> </div>
          <div class="muted" style="margin-top:6px">한글 해석</div>
<div id="typedHangul" class="pill" style="min-height:32px"> </div>

          <div class="muted" style="margin-top:8px">입력한 점자(미리보기)</div>
          <div id="braillePreview" class="brailleRow" aria-label="점자 미리보기"></div>
        </div>

        <div style="min-width:280px;flex:0 0 320px">
          <div class="card" style="margin:0">
            <h2>설정</h2>
            <div class="content">
              <div class="muted">연습 모드에서만 속도 조절 가능</div>
              <div class="slider" style="margin-top:10px">
                <span class="pill">속도</span>
                <input id="speedRange" type="range" min="30" max="220" value="90" />
                <span class="pill" id="speedVal">90</span>
              </div>
              <div class="muted" style="margin-top:10px">
                * 게임 모드에서는 단계가 오를 때 자동으로 빨라짐
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="startBtn">시작</button>
                <button class="btn" id="stopBtn">정지</button>
              </div>
              <div class="muted" style="margin-top:10px">
                제출 키: <b>Space 또는 Enter</b>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Menu Modal -->
<div class="overlay" id="menuOverlay">
  <div class="modal">
    <header>
      <div style="font-weight:950">메뉴</div>
      <button class="btn" id="closeMenuBtn">닫기</button>
    </header>
    <div class="content">
      <div class="card" style="margin:0 0 12px 0">
        <h2>1) 모드 선택</h2>
        <div class="content">
          <div class="grid">
            <button class="btn primary" id="pickPractice">
              연습 모드<br/><span class="muted">속도 조절 가능 / 맞으면 +, 놓치면 -</span>
            </button>
            <button class="btn primary" id="pickGame">
              게임 모드<br/><span class="muted">단계 상승 / 하트 5개 / 게임오버</span>
            </button>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <h2>2) 카테고리 선택 (연습/게임 공통)</h2>
        <div class="content">
          <div class="grid" id="catGrid"></div>
          <div class="muted" style="margin-top:10px">
            카테고리 선택 후 <b>시작</b>을 누르면 시작돼.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div class="overlay" id="overOverlay">
  <div class="modal">
    <header>
      <div style="font-weight:950">게임 오버</div>
      <button class="btn" id="closeOverBtn">닫기</button>
    </header>
    <div class="content">
      <div class="mono">이번 게임 점수: <span class="ok" id="finalScore">0</span></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="retryBtn">다시하기 (1단계)</button>
        <button class="btn" id="backToMenuBtn">메뉴로</button>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 * 카테고리
 * ========================= */
const CATEGORIES = ["초성","종성","모음","약자","부호","숫자","영어","단어"];

/** =========================
 * 문제 데이터 (너가 준 표 그대로 반영)
 * cells는 "셀열" 문자열
 * ========================= */
const BANK = {
  "초성": [
    { text:"ㄱ", cells:"000100" },
    { text:"ㄴ", cells:"100100" },
    { text:"ㄷ", cells:"010100" },
    { text:"ㄹ", cells:"000010" },
    { text:"ㅁ", cells:"100010" },
    { text:"ㅂ", cells:"000110" },
    { text:"ㅅ", cells:"000001" },
    // ㅇ은 초성 생략이라 ‘초성’ 카테고리에서 굳이 안 넣음
    { text:"ㅈ", cells:"000101" },
    { text:"ㅊ", cells:"000011" },
    { text:"ㅋ", cells:"110100" },
    { text:"ㅌ", cells:"110010" },
    { text:"ㅍ", cells:"100110" },
    { text:"ㅎ", cells:"010110" },
    { text:"ㄲ", cells:"000001 000100" },
    { text:"ㄸ", cells:"000001 010100" },
    { text:"ㅃ", cells:"000001 000110" },
    { text:"ㅆ(초성)", cells:"000001 000001" },
    { text:"ㅉ", cells:"000001 000101" },
  ],
  "종성": [
    { text:"ㄱ", cells:"100000" },
    { text:"ㄴ", cells:"010010" },
    { text:"ㄷ", cells:"001010" },
    { text:"ㄹ", cells:"010000" },
    { text:"ㅁ", cells:"010001" },
    { text:"ㅂ", cells:"110000" },
    { text:"ㅅ", cells:"001000" },
    { text:"ㅇ", cells:"011011" },
    { text:"ㅈ", cells:"101000" },
    { text:"ㅊ", cells:"011000" },
    { text:"ㅋ", cells:"011010" },
    { text:"ㅌ", cells:"011001" },
    { text:"ㅍ", cells:"010011" },
    { text:"ㅎ", cells:"001011" },
  ],
  "모음": [
    { text:"ㅏ", cells:"110001" },
    { text:"ㅑ", cells:"001110" },
    { text:"ㅓ", cells:"011100" },
    { text:"ㅕ", cells:"100011" },
    { text:"ㅗ", cells:"101001" },
    { text:"ㅛ", cells:"001101" },
    { text:"ㅜ", cells:"101100" },
    { text:"ㅠ", cells:"100101" },
    { text:"ㅡ", cells:"010101" },
    { text:"ㅣ", cells:"101010" },
    { text:"ㅐ", cells:"111010" },
    { text:"ㅔ", cells:"101110" },
    { text:"ㅚ", cells:"101111" },
    { text:"ㅘ", cells:"111001" },
    { text:"ㅝ", cells:"111100" },
    { text:"ㅢ", cells:"010111" },
    { text:"ㅖ", cells:"001100" },
    { text:"ㅟ", cells:"101100 111010" },
    { text:"ㅒ", cells:"001110 111010" },
    { text:"ㅙ", cells:"111001 111010" },
    { text:"ㅞ", cells:"111100 111010" },
  ],
  "약자": [
    { text:"가", cells:"110101" },
    { text:"나", cells:"010010" },
    { text:"다", cells:"001010" },
    { text:"라", cells:"010000" },
    { text:"마", cells:"010001" },
    { text:"바", cells:"110000" },
    { text:"사", cells:"001000" },
    { text:"아", cells:"011011" },
    { text:"자", cells:"101000" },
    { text:"차", cells:"011000" },
    { text:"카", cells:"011010" },
    { text:"타", cells:"011001" },
    { text:"파", cells:"010011" },
    { text:"하", cells:"001011" },
    { text:"것", cells:"000111 011100" },
    { text:"ㅆ", cells:"001100" },
    { text:"억", cells:"100111" },
    { text:"언", cells:"011111" },
    { text:"얼", cells:"011110" },
    { text:"연", cells:"100001" },
    { text:"열", cells:"110011" },
    { text:"영", cells:"110111" },
    { text:"옥", cells:"101101" },
    { text:"온", cells:"111011" },
    { text:"옹", cells:"111111" },
    { text:"운", cells:"110110" },
    { text:"울", cells:"111101" },
    { text:"은", cells:"101011" },
    { text:"을", cells:"011101" },
    { text:"인", cells:"111110" },
    { text:"그래서", cells:"100000 011100" },
    { text:"그러나", cells:"100000 100100" },
    { text:"그러면", cells:"100000 010010" },
    { text:"그러므로", cells:"100000 010001" },
    { text:"그런데", cells:"100000 101110" },
    { text:"그리고", cells:"100000 101001" },
  ],
  "부호": [
    { text:".", cells:"010011" },
    { text:"?", cells:"011001" },
    { text:"!", cells:"011010" },
    { text:",", cells:"000010" },
    { text:"·", cells:"000010 011000" },
    { text:":", cells:"000010 010000" },
    { text:";", cells:"000011 011000" },
    { text:"“", cells:"011001" },
    { text:"”", cells:"001011" },
    { text:"‘", cells:"000001 011001" },
    { text:"’", cells:"001011 001000" },
    { text:"(", cells:"011001 001000" },
    { text:")", cells:"000001 001011" },
    { text:"{", cells:"011001 011000" },
    { text:"}", cells:"000010 001011" },
    { text:"[", cells:"011001 011000" },
    { text:"]", cells:"000011 001011" },
    { text:"-(붙임표)", cells:"001001" },
    { text:"-(줄표)", cells:"001001 001001" },
    { text:"~", cells:"000100 001010" },
    { text:"｢", cells:"000010 011001" },
    { text:"｣", cells:"001011 010000" },
    { text:"『", cells:"000011 011001" },
    { text:"』", cells:"001011 011000" },
    { text:"······", cells:"000001 000001 000001" },
    { text:"……", cells:"010011 010011 010011" },
    { text:"*", cells:"000010 001010" },
    { text:"※", cells:"000010 001010" },

    { text:"단위표", cells:"001011" },
    { text:"%", cells:"111100" },
    { text:"℃", cells:"100110 000001 100100" },
    { text:"°", cells:"100110" },

    { text:",(자릿값)", cells:"010000" },
    { text:"+", cells:"010001" },
    { text:"-(연산)", cells:"001010" },
    { text:"×", cells:"100001" },
    { text:"÷", cells:"001100 001100" },
    { text:"=", cells:"010010 010010" },
    { text:"(. 괄호열)", cells:"011001" },
    { text:")(. 괄호닫)", cells:"001011" },
    { text:".(소수점)", cells:"010011" },
    { text:"-(분수표)", cells:"001100" },
  ],
  "숫자": [
    { text:"수표", cells:"001111" },
    { text:"1", cells:"100000" },
    { text:"2", cells:"110000" },
    { text:"3", cells:"100100" },
    { text:"4", cells:"100110" },
    { text:"5", cells:"100010" },
    { text:"6", cells:"110100" },
    { text:"7", cells:"110110" },
    { text:"8", cells:"110010" },
    { text:"9", cells:"010100" },
    { text:"0", cells:"010110" },
  ],
  "영어": [
    { text:"로마자표", cells:"001011" },
    { text:"로마자종료표", cells:"010011" },
    { text:"대문자기호표", cells:"000001" },
    { text:"대문자단어표", cells:"000001 000001" },
    { text:"대문자구절표", cells:"000001 000001 000001" },
    { text:"대문자종료표", cells:"000001 001000" },
    { text:"a", cells:"100000" },
    { text:"b", cells:"110000" },
    { text:"c", cells:"100100" },
    { text:"d", cells:"100110" },
    { text:"e", cells:"100010" },
    { text:"f", cells:"110100" },
    { text:"g", cells:"110110" },
    { text:"h", cells:"110010" },
    { text:"i", cells:"010100" },
    { text:"j", cells:"010110" },
    { text:"k", cells:"101000" },
    { text:"l", cells:"111000" },
    { text:"m", cells:"101100" },
    { text:"n", cells:"101110" },
    { text:"o", cells:"101010" },
    { text:"p", cells:"111100" },
    { text:"q", cells:"111110" },
    { text:"r", cells:"111010" },
    { text:"s", cells:"011100" },
    { text:"t", cells:"011110" },
    { text:"u", cells:"101001" },
    { text:"v", cells:"111001" },
    { text:"w", cells:"010111" },
    { text:"x", cells:"101101" },
    { text:"y", cells:"101111" },
    { text:"z", cells:"101011" },
  ],
  "단어": [
    { text:"바람", cells:"000110 000010 110001 010001" },
    { text:"구름", cells:"000100 101100 000010 010101 010001" },
    { text:"연필", cells:"100001 100110 101010 010000" },
    { text:"노을", cells:"100100 101001 011101" },
    { text:"고래", cells:"000100 101001 000010 111010" },
    { text:"별빛", cells:"000110 110001 000110 101010 011000" },
    { text:"파도", cells:"100110 010100 101001" },
    { text:"산책", cells:"111000 010010 000011 111010 100000" },
    { text:"우산", cells:"101100 111000 010010" },
    { text:"달걀", cells:"010100 010000 000100 001110 010000" },
    { text:"초록", cells:"000011 101001 000010 101101" },
    { text:"시간표", cells:"000001 101010 110101 010010 100110 001101" },
    { text:"바위", cells:"000110 110001 101100 111010" },
    { text:"종소리", cells:"000101 111111 000001 101001 000010 101010" },
    { text:"창문", cells:"000011 110001 011011 100010 110110" },
    { text:"지우개", cells:"000101 101010 101100 000100 111010" },
    { text:"낙엽", cells:"100100 100000 100011 110000" },
    { text:"불꽃", cells:"000110 111101 000001 000100 101001 011000" },
    { text:"지도", cells:"000101 101010 010100 101001" },
    { text:"열쇠", cells:"110011 000001 101111" },
    { text:"호수", cells:"010110 101001 000001 101100" },
    { text:"빙하", cells:"000110 101010 011011 010110" },
    { text:"기차역", cells:"000100 101010 000011 110001 100011 100000" },
    { text:"가방끈", cells:"110101 000110 011011 000001 000100 101011" },
    { text:"소나기", cells:"000001 101001 100100 000100 101010" },
    { text:"번개", cells:"000110 011111 000100 111010" },
    { text:"폭풍우", cells:"100110 101101 100110 101100 011011 101100" },
  ],
};

/** =========================
 * 상태
 * ========================= */
const state = {
  mode: null,          // "practice" | "game"
  category: null,
  running: false,
  score: 0,
  level: 1,
  hearts: 5,

  current: null,
  y: 16,
  speed: 90,

  typed: "",           // "000101 110001" 형식 (자동으로 공백 삽입)
};

const UI = {
  modePill: document.getElementById("modePill"),
  catPill: document.getElementById("catPill"),
  score: document.getElementById("score"),
  levelWrap: document.getElementById("levelWrap"),
  level: document.getElementById("level"),
  heartsWrap: document.getElementById("heartsWrap"),
  hearts: document.getElementById("hearts"),

  falling: document.getElementById("falling"),
  fallText: document.getElementById("fallText"),
  fallHint: document.getElementById("fallHint"),
  gameBox: document.getElementById("gameBox"),

  typedRaw: document.getElementById("typedRaw"),
  braillePreview: document.getElementById("braillePreview"),
    typedHangul: document.getElementById("typedHangul"),

  speedRange: document.getElementById("speedRange"),
  speedVal: document.getElementById("speedVal"),

  startBtn: document.getElementById("startBtn"),
  stopBtn: document.getElementById("stopBtn"),
  resetBtn: document.getElementById("resetBtn"),

  menuOverlay: document.getElementById("menuOverlay"),
  openMenuBtn: document.getElementById("openMenuBtn"),
  closeMenuBtn: document.getElementById("closeMenuBtn"),
  pickPractice: document.getElementById("pickPractice"),
  pickGame: document.getElementById("pickGame"),
  catGrid: document.getElementById("catGrid"),

  overOverlay: document.getElementById("overOverlay"),
  finalScore: document.getElementById("finalScore"),
  retryBtn: document.getElementById("retryBtn"),
  closeOverBtn: document.getElementById("closeOverBtn"),
  backToMenuBtn: document.getElementById("backToMenuBtn"),
};

function normCells(s){
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .replace(/[^01 ]/g, "");
}
// =========================
// 셀열 → 한글 해석(현재 카테고리 기준)
// =========================
function cellsToHangul(cellsString){
  const cells = normCells(cellsString).split(" ").filter(Boolean);
  if (cells.length === 0) return "";

  const dict = BANK[state.category] || [];
  let result = [];

  for (const cell of cells) {
    const found = dict.find(item => normCells(item.cells) === cell);
    result.push(found ? found.text : "□"); // 못 찾으면 □
  }

  return result.join("");
}

/** =========================
 * 점자(6점) 렌더
 * ========================= */
function renderBraille(cellsString){
  const wrap = UI.braillePreview;
  wrap.innerHTML = "";

  const cells = normCells(cellsString).split(" ").filter(Boolean);
  for(const bits of cells){
    if(bits.length !== 6) continue;

    const cell = document.createElement("div");
    cell.className = "cell";

    const on = (idx) => bits[idx] === "1";
    const map = [0,3,1,4,2,5]; // 1,4 / 2,5 / 3,6

    for(const bi of map){
      const d = document.createElement("div");
      d.className = "dot" + (on(bi) ? " on" : "");
      cell.appendChild(d);
    }
    wrap.appendChild(cell);
  }
}

function updateHUD(){
  UI.modePill.textContent = `모드: ${state.mode ? (state.mode==="practice" ? "연습" : "게임") : "-"}`;
  UI.catPill.textContent = `카테고리: ${state.category || "-"}`;
  UI.score.textContent = String(state.score);

  UI.levelWrap.style.display = (state.mode==="game") ? "inline-flex" : "none";
  UI.heartsWrap.style.display = (state.mode==="game") ? "inline-flex" : "none";
  UI.level.textContent = String(state.level);
  UI.hearts.textContent = String(state.hearts);

  UI.speedRange.disabled = !(state.mode==="practice");
  UI.speedVal.textContent = String(Number(UI.speedRange.value));
}

function setTyped(s){
  state.typed = normCells(s);

  // 원문(셀열)
  UI.typedRaw.textContent = state.typed || " ";

  // 점자 미리보기
  renderBraille(state.typed);

  // 한글 해석(추가한 div가 있을 때만)
  if (UI.typedHangul) {
    UI.typedHangul.textContent = cellsToHangul(state.typed) || " ";
  }
}


/** =========================
 * 메뉴
 * ========================= */
function openMenu(){ UI.menuOverlay.classList.add("show"); }
function closeMenu(){ UI.menuOverlay.classList.remove("show"); }

function buildCategoryButtons(){
  UI.catGrid.innerHTML = "";
  for(const cat of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = cat;
    btn.onclick = () => {
      state.category = cat;
      updateHUD();
      [...UI.catGrid.querySelectorAll("button")].forEach(b=>b.classList.remove("primary"));
      btn.classList.add("primary");
    };
    UI.catGrid.appendChild(btn);
  }
}

/** =========================
 * 문제 스폰
 * ========================= */
function pickRandomItem(){
  const list = BANK[state.category] || [];
  if(list.length === 0) return null;
  const idx = Math.floor(Math.random()*list.length);
  return list[idx];
}
function spawnNew(){
  state.current = pickRandomItem();
  state.y = 16;
  setTyped("");

  if(!state.current){
    UI.fallText.textContent = "(데이터 없음)";
    return;
  }
  UI.fallText.textContent = state.current.text;
  UI.fallHint.textContent = "Space/Enter로 제출";
  UI.falling.style.top = `${state.y}px`;
}

/** =========================
 * 점수/레벨/하트
 * ========================= */
function addScore(delta){ state.score += delta; updateHUD(); }

function loseHeart(){
  state.hearts -= 1;
  updateHUD();
  if(state.hearts <= 0) gameOver();
}

function maybeLevelUp(){
  if(state.mode !== "game") return;
  const target = 30 * state.level;
  if(state.score >= target){
    state.level += 1;
    state.speed = Math.min(220, state.speed + 15);
    updateHUD();
  }
}

/** =========================
 * 제출(스페이스/엔터)
 * ========================= */
function submitAnswer(){
  if(!state.running || !state.current) return;

  const typed = normCells(state.typed);
  const answer = normCells(state.current.cells);

  // “미완성 셀(6비트 미만)”이면 제출 막음
  const parts = typed.split(" ").filter(Boolean);
  if(parts.length === 0) return;
  if(parts[parts.length-1].length !== 6) return;

  if(typed === answer){
    addScore(+10);
    maybeLevelUp();
    spawnNew();
  }else{
    addScore(-2);
  }
}

/** =========================
 * 루프(낙하)
 * ========================= */
let lastTs = 0;
function loop(ts){
  if(!state.running) return;
  if(!lastTs) lastTs = ts;
  const dt = (ts - lastTs) / 1000;
  lastTs = ts;

  const pxPerSec = (state.mode==="practice")
    ? (Number(UI.speedRange.value) / 2.0)
    : (state.speed / 2.0);

  state.y += pxPerSec * dt;
  UI.falling.style.top = `${state.y}px`;

  const floorY = UI.gameBox.clientHeight - 40 - 44;
  if(state.y >= floorY){
    if(state.mode === "practice"){
      addScore(-5);
      spawnNew();
    }else{
      loseHeart();
      spawnNew();
    }
  }

  requestAnimationFrame(loop);
}

/** =========================
 * 시작/정지/리셋/게임오버
 * ========================= */
function startGame(){
  if(!state.mode || !state.category){
    openMenu();
    return;
  }
  if(state.running) return;

  state.running = true;
  lastTs = 0;

  if(state.mode === "practice"){
    state.speed = Number(UI.speedRange.value);
    state.level = 1;
    state.hearts = 5;
  }else{
    state.level = 1;
    state.hearts = 5;
    state.speed = 60;
  }

  updateHUD();
  spawnNew();
  requestAnimationFrame(loop);
}

function stopGame(){
  state.running = false;
  lastTs = 0;
}

function resetAll(){
  stopGame();
  state.score = 0;
  state.level = 1;
  state.hearts = 5;
  state.current = null;
  state.y = 16;
  setTyped("");
  UI.fallText.textContent = "-";
  updateHUD();
}

function gameOver(){
  stopGame();
  UI.finalScore.textContent = String(state.score);
  UI.overOverlay.classList.add("show");
}

function closeGameOver(){
  UI.overOverlay.classList.remove("show");
}

/** =========================
 * 입력 (점자 동시입력 방식)
 * f d s = 1 2 3
 * j k l = 4 5 6
 * keyup 시 1셀 확정
 * Space / Enter = 제출
 * ========================= */

// 현재 눌려 있는 점들
const pressedDots = new Set();

// 키 → 점 번호
const DOT_KEY_MAP = {
  f: 1, d: 2, s: 3,
  j: 4, k: 5, l: 6,
};

function handleKey(e){
  // 모달 열려 있으면 입력 막기
  if (
    UI.menuOverlay.classList.contains("show") ||
    UI.overOverlay.classList.contains("show")
  ) {
    if (e.key === "Escape") {
      closeMenu();
      closeGameOver();
    }
    return;
  }

  const key = e.key.toLowerCase();

  // 제출
  if (e.code === "Space" || e.key === "Enter") {
    e.preventDefault();
    submitAnswer();
    return;
  }

  // 백스페이스 → 마지막 셀 삭제
  if (e.key === "Backspace") {
    e.preventDefault();
    const parts = state.typed.trim().split(" ").filter(Boolean);
    parts.pop();
    setTyped(parts.join(" "));
    return;
  }

  // 점자 키 눌림
  if (DOT_KEY_MAP[key]) {
    e.preventDefault();
    pressedDots.add(DOT_KEY_MAP[key]);
  }
}

// 키에서 손 뗄 때 = 점자 1셀 확정
document.addEventListener("keyup", (e) => {
  const key = e.key.toLowerCase();
  if (!DOT_KEY_MAP[key]) return;

  if (pressedDots.size === 0) return;

  const bits = [0,0,0,0,0,0];
  pressedDots.forEach(dot => {
    bits[dot - 1] = 1;
  });

  pressedDots.clear();

  const cell = bits.join("");

  const next = state.typed
    ? state.typed + " " + cell
    : cell;

  setTyped(next);
});


/** =========================
 * 이벤트 바인딩
 * ========================= */
UI.speedRange.addEventListener("input", ()=> {
  UI.speedVal.textContent = String(UI.speedRange.value);
  if(state.mode==="practice") state.speed = Number(UI.speedRange.value);
});

UI.startBtn.onclick = startGame;
UI.stopBtn.onclick = stopGame;
UI.resetBtn.onclick = resetAll;

UI.openMenuBtn.onclick = openMenu;
UI.closeMenuBtn.onclick = closeMenu;

UI.pickPractice.onclick = () => { state.mode="practice"; updateHUD(); };
UI.pickGame.onclick = () => { state.mode="game"; updateHUD(); };

UI.closeOverBtn.onclick = closeGameOver;
UI.backToMenuBtn.onclick = () => { closeGameOver(); openMenu(); };
UI.retryBtn.onclick = () => {
  closeGameOver();
  state.mode = "game";
  state.score = 0;
  state.level = 1;
  state.hearts = 5;
  state.speed = 60;
  updateHUD();
  startGame();
};

document.addEventListener("keydown", handleKey);

/** =========================
 * 초기화
 * ========================= */
buildCategoryButtons();
updateHUD();
openMenu();
setTyped("");
</script>
</body>
</html>
